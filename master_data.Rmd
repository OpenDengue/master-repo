---
title: "Master dataset generation"
author: "Ahyoung Lim"
date: "Last update on `r format(Sys.Date(), '%B %d, %Y')`"
output: 
    github_document: default
    html_document:
        theme: flatly
        number_sections: true
        toc: true
        toc_float: true
---


```{r setup, include=FALSE}
require("knitr"); require("here"); require("pacman")
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.path="figure/")
knitr::opts_knit$set(root.dir = here())
pacman::p_load("dplyr", "lubridate",  "tidyr", "tidyverse",  "knitr", "stringi", "zoo", "EpiWeek", "data.table")
```

# Data preprocessing

```{r include = FALSE}
#* This part could be merged into earlier data processing stage
db1 <- read.csv(here("data/transformed_data", "MOH_PAHO_SUB_transformed.csv"))
db2 <- read.csv(here("data/transformed_data", "PAHO_transformed.csv"))
db3 <- read.csv(here("data/transformed_data", "TYCHO_transformed.csv"))

colnames(db1)
plyr::count(db1$source_cat)

db1 <- db1 %>% 
  select(-X) %>%
  mutate(source_cat = ifelse(source_cat %in% c("paho"), "paho_sub", source_cat))

names(db2)
plyr::count(db2$source_cat)

db2 <- db2 %>%
  select(-source_id)

names(db3)
plyr::count(db3$source_cat)

data <- rbind(db1, db2)
data <- rbind(data, db3)
plyr::count(data$source_cat)
rm(db1, db2, db3)

write.csv(data, "data/transformed_data/master_data.csv", row.names=F)
```
Create columns for categorising each row according to it's spatial resolution & temporal resolution.

Convert all case counts from PAHO portal to weekly. While they are currently cumulative with the calendar_end_date increasing weekly, we will be developing models to spread this data across weekly counts before release. In the portal itself, all denge cases are only listed cumulatively in single week increments, while incident "suspected" cases are listed weekly. 

```{r}
data <- read.csv("data/master_data.csv")
head(data)
plyr::count(data$source_cat)
plyr::count(data$adm_0_name)

data <- data %>%
  mutate(calendar_start_date = ymd(calendar_start_date), 
         calendar_end_date = ymd(calendar_end_date), 
         year = year(calendar_end_date), 
         diff = as.duration(interval(calendar_start_date, calendar_end_date))%/% as.duration(days(1)))%>%
  mutate(spatial_res = ifelse(adm_1_name %in% NA & adm_2_name %in% NA,  0, 
                       ifelse(adm_2_name %in% NA, 1, 2)))%>%
  mutate(temporal_res = ifelse(diff <8, 2, #weekly
                          ifelse(diff > 7 & diff < 31, 1, #monthly
                                                       0)))%>% #yearly
  #mutate(temporal_res = ifelse(grepl("all_PAHO", data$source_id, ignore.case = FALSE)== TRUE, "2", temporal_res))%>%
  select(adm_0_name:adm_2_code, spatial_res, temporal_res, year, diff,  calendar_start_date:source_cat)

plyr::count(data$diff)
plyr::count(data$spatial_res)
plyr::count(data$temporal_res)

data %>% 
  select(temporal_res, spatial_res, source_cat)%>% 
  group_by(temporal_res, spatial_res, source_cat)%>% tally()

# **** need to check temporal resolution for some of paho subnational data ****
data <- data %>%
  filter(!diff == 83)
  
```
Convert calendar dates back to epi weeks, to help with tallying the number of weeks at each temporal and spatial resolution.
```{r}
# Overwrite EW as month of the calendar_end_date if the temporal resolution is monthly
data <- data %>%
  mutate(EW = lubridate::week(calendar_end_date))%>%
  mutate(EW = ifelse(temporal_res==1, month(calendar_end_date), 
                ifelse(temporal_res==0, NA, EW)))

```


```{r}
plyr::count(data$adm_0_name)

# Make country names consistent
lookup <- c("Antigua And Barbuda" = "Antigua and Barbuda",
         "Dominican republic" = "Dominican Republic",
         "Saint Kitts And Nevis" = "Saint Kitts and Nevis",
         "Saint Vincent And the Grenadines" = "Saint Vincent and the Grenadines",
         "Saint Vincent And The Grenadines" = "Saint Vincent and the Grenadines",
         "Trinidad And Tobago" = "Trinidad and Tobago", 
         "Turks And Caicos Islands" = "Turks and Caicos Islands", 
         "United States Of America" = "United States of America" 
         )


data <- data %>%
  mutate(adm_0_name = recode(adm_0_name, !!!lookup))

plyr::count(data$adm_0_name) #52 countries
```

